<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link href="css/user.css" rel="stylesheet" />
    <link href="css/select2.min.css" rel="stylesheet" />
</head>

<body>
    <div id="outer">
        <div id="title">
            <label>更新使用者</label>
        </div>
        <div id="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">員編: </label>
            </div>
            <div id="DIV2">
                <select class="uid-select" id="uid" style="width: 200px;">
                    <option value="">請選擇</option>
                </select>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">主管: </label>
            </div>
            <div id="DIV2">
                <input id="managerY" name="manager" type="radio" value="Y"><label>是</label>
                <input id="managerN" name="manager" type="radio" value="N" checked
                    style="margin-left: 40%;"><label>否</label>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">指定人員: </label>
            </div>
            <div id="DIV2">
                <input id="appointedY" name="appointed" type="radio" value="Y"><label>是</label>
                <input id="appointedN" name="appointed" type="radio" value="N" checked
                    style="margin-left: 40%;"><label>否</label>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">安控人員: </label>
            </div>
            <div id="DIV2">
                <input name="security" type="radio" value="SU"><label>是</label>
                <input name="security" type="radio" value="U" checked style="margin-left: 40%;"><label>否</label>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large; ">部門 / 分行: </label>
            </div>
            <div id="DIV2">
                <select id="dept" style="width: 220px;height: 30px;"></select>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">派駐單位: </label>
            </div>
            <div id="DIV2">
                <select id="branch" style="width: 220px; height: 30px;"></select>
            </div>
        </div>
        <div class="inner">
            <div id="DIV1">
                <label style="font-size: x-large;">業務種類: </label>
            </div>
        </div>
        <div class="inner">
            <div id="DIV3">
                <div id="cblist"></div>
            </div>
        </div>
        <div class="inner">
            <button type="button" onclick="goCheckPage('U')">更新</button>
        </div>
    </div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/select2.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        $(function () {

            if (localStorage.getItem("userId") == null) {
                location.href = "login.html";
            }
            var dept = localStorage.getItem("dept");
            var branch = localStorage.getItem("branch");
            var security = localStorage.getItem("security");
            if (security == "U") {
                history.go(-1);
            }
            if (dept != null) {
                if (!dept.match("100|800|600")) {
                    $("#securityDiv").hide();
                    $("#deptDiv").hide();
                    $("#branchDiv").hide();
                }
            }
            $.ajax({
                url: `${ip}webcam_web_api/api/User/${branch}/${dept}`,
                type: "GET",
                contentType: "application/json;charset=utf-8",
                async: false,
                success: function (returnData) {
                    if (returnData.code == 0) {
                        var dataList = returnData['data'];
                        for (var i = 0; i < dataList.length; i++) {
                            if (dataList[i]["userId"] == localStorage.getItem("userId") && security != "AU") continue;
                            $('#uid').append($('<option />', { value: JSON.stringify(dataList[i]), text: dataList[i]["userId"] }));
                        }
                    } else {
                        alert(returnData.message);
                    }
                },
            })
            $.ajax({
                url: `${ip}webcam_web_api/api/WorkReference`,
                type: "GET",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                async: false,
                success: function (returnData) {
                    console.log(returnData);
                    if (returnData.code == 0) {
                        var dataList = returnData['data'];
                        for (var i = 0; i < dataList.length; i++) {
                            let workType = dataList[i]["workType"];

                            var idiv = document.createElement('div');
                            var checkbox = document.createElement('input');
                            var label = document.createElement('label');


                            idiv.id = "group" + (i + 1);
                            idiv.style = "width:33%; float:left;"
                            document.getElementById('cblist').appendChild(idiv)

                            checkbox.setAttribute('type', 'checkbox');
                            checkbox.setAttribute('name', 'workType');
                            checkbox.setAttribute('value', dataList[i]['workType']);
                            idiv.appendChild(checkbox);

                            label.setAttribute('text',dataList[i]["workName"]);
                            label.innerHTML = dataList[i]["workName"];
                            label.setAttribute('for',workType);
                            idiv.appendChild(label);
                        }
                    } else {
                        alert(returnData.message);
                    }
                },
            });
            searchBranch();
            $(".uid-select").select2();

            if (dept == branch && !dept.match("100|800|600") && !dept.startsWith("0")) {
                $("input[name=manager]").change(function () {
                    if ($(this).val() == "Y") {
                        $('input[name=workType]').prop("disabled", false);
                    } else {
                        $(`input[name=workType][value!=${dept}]`).prop("disabled", true);
                        $(`input[name=workType][value!=${dept}]`).prop("checked", false);
                    }
                })
            }
            $("#uid").change(function () {
                $("#uid option[value='']").remove();
                var data = JSON.parse($("#uid").val());
                if (data != "") {
                    $('input[name=manager]').each(function (index, element) {
                        if ($(element).val() == data.manager) {
                            $(element).prop("checked", true);
                        }
                    })
                    $('input[name=appointed]').each(function (index, element) {
                        if ($(element).val() == data.appointed) {
                            $(element).prop("checked", true);
                        }
                    })
                    $('input[name=security]').each(function (index, element) {
                        if ($(element).val() == data.security) {
                            $(element).prop("checked", true);
                        }
                    })
                    $("input[name=workType]").prop("checked", false);
                    $("input[name=workType]").each(function (index, element) {
                        if (data.workType.match($(element).val())) {
                            $(element).prop("checked", true);
                        }
                    })
                    $("#dept").val(data.dept);
                    $("#branch").val(data.branch);

                    if (dept == branch && !dept.match("100|800|600") && !dept.startsWith("0")) {
                        if (data.manager == "Y") {
                            $('input[name=workType]').prop("disabled", false);
                        } else {
                            $(`input[name=workType][value!=${data.dept}]`).prop("disabled", true);
                            $(`input[name=workType][value!=${data.dept}]`).prop("checked", false);
                        }
                    }
                }
            })

            $("input[name=manager]").change(function () {
                if ($(this).val() == "Y") {
                    $("#appointedN").prop("checked", true);
                }
            })

            $("input[name=appointed]").change(function () {
                if ($(this).val() == "Y") {
                    $("#managerN").prop("checked", true);
                }
            })

        })
    </script>
</body>

</html>